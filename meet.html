<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Meeting+</title>
<style>
  body { margin:0; font-family:sans-serif; background:#f0f0f0; }
  header { padding:10px; background:#0a6; color:#fff; text-align:center; font-size:24px; }
  #roomScreen { display:none; padding:10px; }
  #participants { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap:10px; margin-bottom:10px; }
  .participant { background:#000; color:#fff; border-radius:6px; height:120px; display:flex; align-items:center; justify-content:center; flex-direction:column; }
  video { width:100%; height:auto; border-radius:6px; }
  #controls { display:flex; flex-wrap: wrap; justify-content:center; gap:10px; margin-bottom:10px; }
  #subtitleBox { background:rgba(0,0,0,0.1); padding:5px; border-radius:5px; margin-bottom:10px; text-align:center; font-size:16px; min-height:20px; }
  #chatContainer { display:flex; flex-direction:column; align-items:center; }
  #chatBox { width:80%; height:150px; overflow-y:auto; border:1px solid gray; background:#fff; padding:5px; border-radius:5px; margin-bottom:5px; }
  input, button { padding:5px; margin:2px; font-size:14px; border-radius:4px; border:1px solid #ccc; }
  #roomMessage { color:red; margin-bottom:5px; }
</style>
</head>
<body>

<header>Meeting+</header>

<div id="roomScreen">
  <div id="participants">
    <div class="participant" id="selfVideo">
      <span>è‡ªåˆ†</span>
      <video id="selfCam" autoplay muted></video>
    </div>
    <div class="participant">å‚åŠ è€…1</div>
    <div class="participant">å‚åŠ è€…2</div>
  </div>

  <div id="controls">
    <button onclick="toggleMic()">ğŸ¤ ãƒã‚¤ã‚¯</button>
    <button onclick="toggleCam()">ğŸ“· ã‚«ãƒ¡ãƒ©</button>
    <button onclick="shareScreen()">ğŸ–¥ ç”»é¢å…±æœ‰</button>
    <button onclick="stopShare()">åœæ­¢</button>
    <button onclick="startCaption()">å­—å¹•ã‚ªãƒ³</button>
    <button onclick="stopCaption()">å­—å¹•ã‚ªãƒ•</button>
    <button onclick="exitRoom()">é€€å‡º</button>
  </div>

  <div id="subtitleBox">ğŸ¤ å­—å¹•ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

  <div id="chatContainer">
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›">
    <div>
      <button onclick="sendMessage()">é€ä¿¡</button>
      <button onclick="sendStamp('ğŸ‘')">ğŸ‘</button>
      <button onclick="sendStamp('ğŸ˜‚')">ğŸ˜‚</button>
      <button onclick="sendStamp('ğŸ‰')">ğŸ‰</button>
    </div>
  </div>
</div>

<div id="joinScreen" style="padding:10px; text-align:center;">
  <input type="text" id="roomId" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
  <button onclick="enterRoom()">å‚åŠ  / ä½œæˆ</button>
  <p id="roomMessage"></p>
</div>

<script>
  // --- ãƒ«ãƒ¼ãƒ ç®¡ç† ---
  let rooms = {};
  function enterRoom(){
    const roomId = document.getElementById("roomId").value.trim();
    if(!roomId){ document.getElementById("roomMessage").innerText="ãƒ«ãƒ¼ãƒ IDãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"; return;}
    if(!rooms[roomId]) rooms[roomId] = [];
    document.getElementById("roomMessage").innerText="";
    document.getElementById("joinScreen").style.display="none";
    document.getElementById("roomScreen").style.display="block";
    startCam(); // å…¥å®¤æ™‚ã«ã‚«ãƒ¡ãƒ©é–‹å§‹
  }

  // --- ãƒã‚¤ã‚¯ / ã‚«ãƒ¡ãƒ© ---
  let micOn=true, camOn=true;
  let localStream;
  async function startCam(){
    try{
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      document.getElementById("selfCam").srcObject = localStream;
    }catch(err){
      alert("ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯å–å¾—å¤±æ•—:"+err);
    }
  }
  function toggleMic(){
    if(!localStream) return;
    micOn = !micOn;
    localStream.getAudioTracks().forEach(track => track.enabled = micOn);
    alert("ãƒã‚¤ã‚¯:"+ (micOn?"ã‚ªãƒ³":"ã‚ªãƒ•"));
  }
  function toggleCam(){
    if(!localStream) return;
    camOn = !camOn;
    localStream.getVideoTracks().forEach(track => track.enabled = camOn);
    alert("ã‚«ãƒ¡ãƒ©:"+ (camOn?"ã‚ªãƒ³":"ã‚ªãƒ•"));
  }

  // --- å­—å¹• ---
  let recognition;
  function startCaption(){
    if(!('webkitSpeechRecognition' in window)){ alert("Chromeã§å®Ÿè¡Œã—ã¦ãã ã•ã„"); return;}
    recognition=new webkitSpeechRecognition();
    recognition.lang="ja-JP";
    recognition.continuous=true;
    recognition.interimResults=true;
    recognition.onresult=function(event){
      let transcript="";
      for(let i=event.resultIndex;i<event.results.length;i++) transcript+=event.results[i][0].transcript;
      document.getElementById("subtitleBox").innerText=transcript;
    };
    recognition.start();
  }
  function stopCaption(){
    if(recognition) recognition.stop();
    document.getElementById("subtitleBox").innerText="ğŸ¤ å­—å¹•ã¯åœæ­¢ã—ã¾ã—ãŸ";
  }

  // --- ç”»é¢å…±æœ‰ ---
  let screenStream;
  async function shareScreen(){
    try{
      screenStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
      const selfDiv=document.getElementById("selfVideo");
      selfDiv.querySelector("span").innerText="å…±æœ‰ä¸­";
      screenStream.getVideoTracks()[0].addEventListener("ended",stopShare);
    }catch(err){ alert("ç”»é¢å…±æœ‰å¤±æ•—:"+err); }
  }
  function stopShare(){
    if(screenStream){
      screenStream.getTracks().forEach(t=>t.stop());
      screenStream=null;
    }
    document.getElementById("selfVideo").querySelector("span").innerText="è‡ªåˆ†";
  }

  // --- ãƒãƒ£ãƒƒãƒˆ ---
  function sendMessage(){
    const msg=document.getElementById("chatInput").value.trim();
    if(!msg) return;
    document.getElementById("chatBox").innerHTML+="<div>ğŸ“ "+msg+"</div>";
    document.getElementById("chatInput").value="";
    document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
  }
  function sendStamp(stamp){
    document.getElementById("chatBox").innerHTML+="<div>"+stamp+"</div>";
    document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
  }

  // Enterã‚­ãƒ¼ã§é€ä¿¡
  document.getElementById("chatInput").addEventListener("keypress", function(e){
    if(e.key === "Enter") sendMessage();
  });

  // --- é€€å‡º ---
  function exitRoom(){
    document.getElementById("roomScreen").style.display="none";
    document.getElementById("joinScreen").style.display="block";
    document.getElementById("roomId").value="";
    if(localStream){
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    stopShare();
    stopCaption();
  }
</script>

</body>
</html>